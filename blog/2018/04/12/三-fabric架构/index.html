<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>三 Fabric架构 - Pinvon&#39;s Blog</title>
    <meta charset="utf-8" />
    <meta name="author" content="Pinvon" />
    <meta name="description" content="&lt;TODO: insert your description here&gt;" />
    <meta name="keywords" content="&lt;TODO: insert your keywords here&gt;" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">Pinvon&#39;s Blog</a></h1>
        <p>所见，所闻，所思，所想</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/pinvondev">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="pinvondev.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>三 Fabric架构</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfb68878">架构</a>
<ul>
<li><a href="#orgf4e709d">身份管理</a></li>
<li><a href="#orga5498e7">账本管理</a></li>
<li><a href="#orga8ff326">交易管理</a></li>
<li><a href="#org33da2a5">智能合约</a></li>
<li><a href="#org006a9f2">成员管理</a></li>
<li><a href="#org0b56318">共识服务</a></li>
<li><a href="#org8bf6894">chaincode服务</a></li>
<li><a href="#orgcabb542">安全和密码服务</a></li>
<li><a href="#org939129c">网络节点架构</a>
<ul>
<li><a href="#org8f8f77b">客户端节点</a></li>
<li><a href="#orga32595d">Peer节点</a></li>
<li><a href="#orgdbada89">Orderer节点</a></li>
<li><a href="#orge08b5d0">CA节点</a></li>
<li><a href="#orgfead6fe">交易流程</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgcd5f505">交易详情</a>
<ul>
<li><a href="#orge10cb12">创建交易提案并发送给背书节点</a></li>
<li><a href="#org05d6733">背书节点模拟交易并生成背书签名</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgfb68878" class="outline-2">
<h2 id="orgfb68878">架构</h2>
<div class="outline-text-2" id="text-orgfb68878">

<div class="figure">
<p><img src="/assets/blog/2018/04/12/三-fabric架构/34.png" alt="34.png" />
</p>
</div>

<p>
在上层提供了标准的gRPC接口, 在API的基础上封装了不同语言的SDK.
</p>

<p>
区块链强一致性要求, 各个节点之间达成共识需要较长的执行时间, 也是采用异步通信的模式进行开发的, 事件模块可以在触发区块事件或者chaincode事件的时候执行预先定义的回调函数.
</p>
</div>

<div id="outline-container-orgf4e709d" class="outline-3">
<h3 id="orgf4e709d">身份管理</h3>
<div class="outline-text-3" id="text-orgf4e709d">
<p>
用户注册和登录系统后, 获取到用户注册证书(ECert). 后续的所有操作都要使用和用户证书相关联的私钥进行签名, 消息接收方首先会进行签名验证, 才进行后续的消息处理.
</p>

<p>
网络节点也会用到颁发的证书, 如系统启动和网络节点管理等, 都会对用户身份进行认证和授权.
</p>
</div>
</div>

<div id="outline-container-orga5498e7" class="outline-3">
<h3 id="orga5498e7">账本管理</h3>
<div class="outline-text-3" id="text-orga5498e7">
<p>
授权的用户是可以查询账本数据的, 可以通过多种方式查询, 包括根据区块号查询区块, 根据区块哈希查询区块, 根据交易号查询区块, 根据交易号查询交易, 根据channel名称获取查询到的区块链信息.
</p>
</div>
</div>

<div id="outline-container-orga8ff326" class="outline-3">
<h3 id="orga8ff326">交易管理</h3>
<div class="outline-text-3" id="text-orga8ff326">
<p>
<code>账本数据只能通过交易执行才能得到更新</code>, 应用程序通过交易管理提交交易提案(proposal), 并获取到交易背书(endorsement)后, 再给ordering service提交交易, 然后打包成区块. SDK提供接口, 利用用户证书本地生成交易号, 背书节点和记账节点都会校验是否存在重复交易.
</p>
</div>
</div>

<div id="outline-container-org33da2a5" class="outline-3">
<h3 id="org33da2a5">智能合约</h3>
<div class="outline-text-3" id="text-org33da2a5">
<p>
通过chaincode执行提交的交易, 实现基于区块链的智能合约业务逻辑. <code>只有智能合约都能更新账本数据, 其他模块不能直接修改状态数据(world state)</code>.
</p>
</div>
</div>

<div id="outline-container-org006a9f2" class="outline-3">
<h3 id="org006a9f2">成员管理</h3>
<div class="outline-text-3" id="text-org006a9f2">
<p>
MSP(Membership Service Provider)对成员管理进行了抽象, <code>一般来说, 一个组织对应一个MSP</code>, 每个MSP都会建立一套根信任证书体系, 利用PKI对成员身份进行认证, 验证成员用户提交请求的签名. 
</p>

<p>
MSP结合Fabric-CA或第三方CA系统, 提供成员注册功能, 并对成员身份证书进行管理(如新增, 撤销).
</p>

<p>
注册的证书分为登记证书(ECert), 交易证书(TCert), TLS证书, 它们分别用于用户身份确认, 交易签名, TLS传输.
</p>
</div>
</div>

<div id="outline-container-org0b56318" class="outline-3">
<h3 id="org0b56318">共识服务</h3>
<div class="outline-text-3" id="text-org0b56318">
<p>
共识机制由3个阶段完成:
</p>
<ol class="org-ol">
<li>客户端向背书节点提交提案, 进行背书签名</li>
<li>客户端将背书后的交易提交给ordering service进行交易排序, 生成区块和排序服务</li>
<li>orderer将区块广播给记账节点验证交易, 然后写入本地账本</li>
</ol>

<p>
共识机制, 目的是为了实现同一个链上不同节点区块的一致性, 同时确保区块里的交易有效和有序.
</p>
</div>
</div>

<div id="outline-container-org8bf6894" class="outline-3">
<h3 id="org8bf6894">chaincode服务</h3>
<div class="outline-text-3" id="text-org8bf6894">
<p>
chaincode的实现依赖于安全的执行环境, 确保安全的执行过程和用户数据的隔离.
</p>

<p>
Hyperledger Fabric采用Docker管理普通的chaincode.
</p>
</div>
</div>

<div id="outline-container-orgcabb542" class="outline-3">
<h3 id="orgcabb542">安全和密码服务</h3>
<div class="outline-text-3" id="text-orgcabb542">
<p>
Hyperledger Fabric专门定义了一个BCCSP(BlockChain Cryptographic Service Provider)来实现密钥生成, 哈希运算, 签名验证, 加密解密等基础功能. BCCSP是一个抽象的接口.
</p>
</div>
</div>

<div id="outline-container-org939129c" class="outline-3">
<h3 id="org939129c">网络节点架构</h3>
<div class="outline-text-3" id="text-org939129c">
<p>
节点是区块链的通信主体, 多个不同类型的节点(客户端, Peer, Orderer, CA)可以运行在同一物理服务器上.
</p>

<p>
如图所示:
</p>


<div class="figure">
<p><img src="/assets/blog/2018/04/12/三-fabric架构/35.png" alt="35.png" />
</p>
</div>
</div>

<div id="outline-container-org8f8f77b" class="outline-4">
<h4 id="org8f8f77b">客户端节点</h4>
<div class="outline-text-4" id="text-org8f8f77b">
<p>
客户端或者应用程序代表最终用户操作的实体, 它必须连接到某一个Peer或者Orderer上, 与区块链网络进行通信. 客户端向背书节点提交交易提案, 当收集到足够背书后, 向排序服务广播交易, 进行排序, 生成区块.
</p>
</div>
</div>

<div id="outline-container-orga32595d" class="outline-4">
<h4 id="orga32595d">Peer节点</h4>
<div class="outline-text-4" id="text-orga32595d">
<p>
部分节点是背书节点, 对提案进行背书. 每个chaincode在实例化的时候都会设置背书策略, 指定哪些节点对提案进行背书.
</p>

<p>
所有Peer节点都是提交节点(Committer, 也有人称为记账节点), 负责验证从Orderer节点广播的区块里的交易, 维护状态数据和账本的副本.
</p>

<p>
主节点作为组织的代表, 和Orderer节点通信, 负责从Orderer节点获取最新的区块, 并在组织内同步. 主节点可以自己设置, 也可以动态选举产生.
</p>
</div>
</div>

<div id="outline-container-orgdbada89" class="outline-4">
<h4 id="orgdbada89">Orderer节点</h4>
<div class="outline-text-4" id="text-orgdbada89">
<p>
Orderer接收包含背书签名的交易, 对未打包的交易进行排序, 生成区块, 广播给Peer节点.
</p>

<p>
Ordering Service的multi-channel实现了多链的数据隔离, 保证只有同一个链的Peer节点都能访问链上的数据, 保护用户数据的隐私.
</p>
</div>
</div>

<div id="outline-container-orge08b5d0" class="outline-4">
<h4 id="orge08b5d0">CA节点</h4>
<div class="outline-text-4" id="text-orge08b5d0">
<p>
CA节点是证书颁发机构, 有服务器和客户端. CA节点接收客户端的注册申请, 返回一次性密码用于用户登录, 以便获取身份证书.
</p>

<p>
在区块链网络上, 所有的操作都会验证用户的身份. CA节点是可选的, 可以用其他成熟的第三方CA颁发证书.
</p>
</div>
</div>

<div id="outline-container-orgfead6fe" class="outline-4">
<h4 id="orgfead6fe">交易流程</h4>
<div class="outline-text-4" id="text-orgfead6fe">
<p>
交易流程如下图所示:
</p>


<div class="figure">
<p><img src="/assets/blog/2018/04/12/三-fabric架构/36.png" alt="36.png" />
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcd5f505" class="outline-2">
<h2 id="orgcd5f505">交易详情</h2>
<div class="outline-text-2" id="text-orgcd5f505">
</div>
<div id="outline-container-orge10cb12" class="outline-3">
<h3 id="orge10cb12">创建交易提案并发送给背书节点</h3>
<div class="outline-text-3" id="text-orge10cb12">
<p>
客户端签名后的提案, 数据格式如下:
</p>
<div class="org-src-container">
<pre class="src src-JSON">SignedProposal:{
    ProposalBytes(Proposal):{
        Header:{
            ChannelHeader:{
                Type:"HeaderType_ENDORSER_TRANSACTION",
                TxID:TxId,
                Timestamp:Timestamp,
                ChannelId:ChannelId,
                Extension(ChaincodeHeaderExtension):{
                    PayloadVisibility:PayloadVisibility,
                    ChaincodeId:{
                        Path:Path,
                        Name:Name,
                        Version:Version
                    }
                },
                Epoch:Epoch
            },
            SignatureHeader:{
                Creator:Creator,
                Nonce:Nonce
            }
        },
        Payload:{
            ChaincodeProposalPayload:{
                Input(ChaincodeInvocationSpec):{
                    ChaincodeSpec:{
                        Type:Type,
                        ChaincodeId:{
                            Name:Name
                        },
                        Input(ChaincodeInput):{
                            Args:[]
                        }
                    }
                },
                TransientMap:TransientMap
            }
        }
    },
    Signature:Signature
}
</pre>
</div>

<p>
SignProposal = Proposal + Signature;
Proposal = ChannelHeader + SignatureHeader
</p>

<p>
背书节点会根据签名信息 <code>Signature</code> 验证其是否是一个有效的交易.
</p>

<p>
ChannelHeader: 包含了channel和chaincode调用相关的信息, 如在哪个channel上调用哪个chaincode; TxID是客户端生成的交易号, 跟客户端的身份证书相关, 可以避免交易号的冲突, 背书节点和提交节点都会验证是否重复交易.
</p>

<p>
SignatureHeader: 包含客户端的身份证书和一个随机数, 用于验证消息的有效性.
</p>

<p>
客户端构造好交易提案请求, 选择背书节点并进行背书签名. 背书节点在背书策略中指定.
</p>
</div>
</div>

<div id="outline-container-org05d6733" class="outline-3">
<h3 id="org05d6733">背书节点模拟交易并生成背书签名</h3>
<div class="outline-text-3" id="text-org05d6733">
<p>
背书节点收到交易提案后, 进行一些验证, 包括:
</p>
<ol class="org-ol">
<li>交易提案的格式是否正确</li>
<li>交易是否提交过</li>
<li>交易签名是否有效(通过MSP)</li>
<li>交易提案的提交者在当前channel是否已授权有写权限</li>
</ol>

<p>
验证通过后, 背书节点会根据当前账本数据, 模拟执行chaincode中的业务逻辑, 并生成 <code>读写集</code>, 但实际上并不更新账本数据. 然后背书节点对这些读写集进行签名, 成为提案响应(ProposalResponse), 返回给客户端.
</p>

<p>
ProposalResponse的结构如下:
</p>
<div class="org-src-container">
<pre class="src src-JSON">ProposalResponse:{
    Version:Version,
    Timestamp:Timestamp,
    Response:{
        Status:Status,
        Message:Message,
        Payload:Payload
    },
    Payload(ProposalResponsePayload):{
        ProposalHash:ProposalHash,
        Extension(ChaincodeAction):{
            Results(TxRwSet):{
                NsRwSets(NsRwSets):[
                    NameSpace:NameSpace,
                    KvRwSet:{
                        Reads(KVRead):[
                            Key:Key,
                            Version:{
                                BlockNum:BlockNum,
                                TxNum:TxNum
                            }
                        ],
                        RangeQueriesInfo(RangeQueriesInfo):[
                            StartKey:StartKey,
                            EndKey:EndKey,
                            ItrExhausted:ItrExhausted,
                            ReadsInfo:ReadsInfo
                        ],
                        Writes(KVWrite):[
                            Key:Key,
                            IsDelete:IsDelete,
                            Value:Value
                        ]
                    }
                ]
            },
            Events(ChaincodeEvent):{
                ChaincodeId:ChaincodeId,
                TxId:TxId,
                EventName:EventName,
                Payload:Payload
            }
            Response:{
                Status:Status,
                Message:Message,
                Payload:Payload
            },
            ChaincodeId:ChaincodeId
        }
    },
    Endorsement:{
        Endorser:Endorser,
        Signature:Signature
    }
}
</pre>
</div>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2018-04-12</span>
        <span title="last modification date" class="post-info">2018-04-13</span>
        <span title="tags" class="post-info"><a href="/tags/blockchain/">BlockChain</a></span>
        <span title="author" class="post-info">Pinvon</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2018/04/12/三-fabric架构";
          var disqus_url = "http://pinvondev.github.io/blog/2018/04/12/三-fabric架构";
          var disqus_shortname = 'pinvon';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
       <div id="hashover"></div>
       <script type="text/javascript" src="/hashover.php"></script>
       <noscript>You must have JavaScript enabled to use the comments.</noscript>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:pinvon &lt;at&gt; Inspiron">Pinvon</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
