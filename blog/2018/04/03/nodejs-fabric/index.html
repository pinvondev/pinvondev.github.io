<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Node.js Fabric - Pinvon&#39;s Blog</title>
    <meta charset="utf-8" />
    <meta name="author" content="Pinvon" />
    <meta name="description" content="&lt;TODO: insert your description here&gt;" />
    <meta name="keywords" content="&lt;TODO: insert your keywords here&gt;" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">Pinvon&#39;s Blog</a></h1>
        <p>所见，所闻，所思，所想</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/pinvondev">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="pinvondev.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>Node.js Fabric</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org59ca671">概述</a>
<ul>
<li><a href="#orgd87a2f4">fabric-client</a></li>
<li><a href="#org0263375">fabric-ca-client</a></li>
</ul>
</li>
<li><a href="#org6ea8f53">配置应用程序开发环境</a>
<ul>
<li><a href="#org9d144b5">开发环境组成</a>
<ul>
<li><a href="#org5167933">orderer</a></li>
<li><a href="#org5c63259">peer</a></li>
<li><a href="#org35f6b1a">身份</a></li>
</ul>
</li>
<li><a href="#org002be3e">前提</a>
<ul>
<li><a href="#org7996be4">Docker</a></li>
<li><a href="#org4c92ef0">Docker Compose</a></li>
<li><a href="#org33a546d">Nodejs(v6.2.0-6.10.0)</a></li>
</ul>
</li>
<li><a href="#org750047f">准备加密材料</a></li>
<li><a href="#orge26887d">创世区块</a></li>
<li><a href="#org4488ec3">启动网络</a></li>
</ul>
</li>
<li><a href="#orgcbaef56">如何创建channel</a>
<ul>
<li><a href="#org9da7ea9">步骤</a></li>
<li><a href="#org8f4ba90">使用*.tx构建可签名的channel配置</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org59ca671" class="outline-2">
<h2 id="org59ca671">概述</h2>
<div class="outline-text-2" id="text-org59ca671">
<p>
Hypeledger Fabric SDK for Node.js 提供了强大的API, 让我们与区块链进行交互. 使用这些API, 我们可以做到:
</p>
<ul class="org-ul">
<li>创建channels</li>
<li>将peer加入channel</li>
<li>在peer上安装chaincode</li>
<li>在channel上实例化chaincode</li>
<li>通过chaincode调用事务</li>
<li>查询账本</li>
</ul>

<p>
为了安全起见, 在Fabric中需要使用数字签名. 用户通过证书, 要对所有的Fabric请求进行签名(用户对请求进行签名, 再附上从CA获取的数字证书, Fabric使用CA的公钥解开数字证书, 拿到用户的公钥, 这样就能证明数字签名是否真的是用户签的). <a href="http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html#table-of-contents">关于Fabric CA</a>.
</p>
</div>

<div id="outline-container-orgd87a2f4" class="outline-3">
<h3 id="orgd87a2f4">fabric-client</h3>
<div class="outline-text-3" id="text-orgd87a2f4">
<ul class="org-ul">
<li><a href="https://fabric-sdk-node.github.io/Client.html#createChannel">创建channel</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#joinChannel">将peer加入channel</a></li>
<li><a href="https://fabric-sdk-node.github.io/Client.html#installChaincode">将chaincode安装到peer</a></li>
<li>在channel上实例化chaincode, 包括两步: <a href="https://fabric-sdk-node.github.io/Channel.html#sendInstantiateProposal">将提案发送到背书节点</a> 和 <a href="https://fabric-sdk-node.github.io/Channel.html#sendTransaction">将提案回复发送到Orderer节点</a></li>
<li>提交事务, 包括两步: <a href="https://fabric-sdk-node.github.io/Channel.html#sendInstantiateProposal">将提案发送到背书节点</a> 和 <a href="https://fabric-sdk-node.github.io/Channel.html#sendTransaction">将提案回复发送到Orderer节点</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#queryByChaincode">查询chaincode以获得最新的应用程序状态</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#queryInfo">查询其他的channel状态</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#queryBlock">查询块(通过number)</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#queryBlockByHash">查询块(通过hash)</a></li>
<li><a href="https://fabric-sdk-node.github.io/Client.html#queryChannels">peer属于哪些channel</a></li>
<li><a href="https://fabric-sdk-node.github.io/Client.html#queryInstalledChaincodes">peer上安装的所有chaincode</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#queryInstantiatedChaincodes">peer上实例化的所有chaincode</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#queryTransaction">查询事务(通过id)</a></li>
<li><a href="https://fabric-sdk-node.github.io/Channel.html#getChannelConfig">channel的配置数据</a></li>
<li><a href="https://fabric-sdk-node.github.io/EventHub.html#connect">与peer事件建立联系</a></li>
<li><a href="https://fabric-sdk-node.github.io/EventHub.html#registerBlockEvent">监听块事件</a></li>
<li><a href="https://fabric-sdk-node.github.io/EventHub.html#registerTxEvent">监听交易事件以获知是否成功写入账本</a></li>
<li><a href="https://fabric-sdk-node.github.io/EventHub.html#registerChaincodeEvent">自定义一些由chaincode产生的事件</a></li>
<li><a href="https://fabric-sdk-node.github.io/User.html">序列化用户类(已经登记, 并由登记证书和签名密钥表示)</a></li>
<li>具有多层覆盖的分层配置设置: 文件, 环境变量, 程序参数, 内存中设置</li>
<li>内置的日志系统为winston, 也可以使用常用的log4j</li>
<li>可插入的CryptoSuite接口描述与Fabric成功交互所需的加密操作. 提供两种实现方式: <a href="https://fabric-sdk-node.github.io/CryptoSuite_ECDSA_AES.html">Software-based ECDSA</a>和<a href="https://fabric-sdk-node.github.io/CryptoSuite_PKCS11.html">PKCS#11-compliant ECDSA</a></li>
<li>可插拔的状态存储接口, 用于保存诸如用户的状态缓存: <a href="https://fabric-sdk-node.github.io/FileKeyValueStore.html">存储到文件</a>和<a href="https://fabric-sdk-node.github.io/CouchDBKeyValueStore.html">存储到CouchDB</a></li>
<li><a href="https://fabric-sdk-node.github.io/CryptoKeyStore.html">可自定义的加密密钥库</a></li>
<li>支持使用TLS(grpcs://)和非TLS(grcp://)与peer和orderer连接. 可查看<a href="https://fabric-sdk-node.github.io/Remote.html">Remote类</a>, 它是peers和orderers的父类.</li>
</ul>
</div>
</div>

<div id="outline-container-org0263375" class="outline-3">
<h3 id="org0263375">fabric-ca-client</h3>
<div class="outline-text-3" id="text-org0263375">
<ul class="org-ul">
<li><a href="https://fabric-sdk-node.github.io/FabricCAServices.html#register">注册新用户</a></li>
<li><a href="https://fabric-sdk-node.github.io/FabricCAServices.html#enroll">登记一个用户, 获得Fabric CA签名的登记证书</a></li>
<li><a href="https://fabric-sdk-node.github.io/FabricCAServices.html#revoke">通过登记ID注销用户或注销某证书</a></li>
<li><a href="https://fabric-sdk-node.github.io/FabricCAServices.html">自定义持久化存储</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6ea8f53" class="outline-2">
<h2 id="org6ea8f53">配置应用程序开发环境</h2>
<div class="outline-text-2" id="text-org6ea8f53">
<p>
chaincode运行在服务器(背书节点), 客户端使用node.js编写.
</p>
</div>

<div id="outline-container-org9d144b5" class="outline-3">
<h3 id="org9d144b5">开发环境组成</h3>
<div class="outline-text-3" id="text-org9d144b5">
</div>
<div id="outline-container-org5167933" class="outline-4">
<h4 id="org5167933">orderer</h4>
<div class="outline-text-4" id="text-org5167933">
<p>
orderer节点的主要责任是共识. 那么, 为什么应用程序开发需要orderer?
</p>

<p>
因为orderer节点维护了整个网络的关键数据, 如: 哪些组织加入了, 哪些channel创建了, 哪个组织加入了哪个channel, 对网络的改变需要遵循哪些策略. 本质上来讲, ordering service掌握了整个网络.
</p>
</div>
</div>

<div id="outline-container-org5c63259" class="outline-4">
<h4 id="org5c63259">peer</h4>
<div class="outline-text-4" id="text-org5c63259">
<p>
peer节点分两种: 背书节点和提交节点. 在配置文件中, 一个节点是否是背书节点, 需要自己配置. 而提交节点则无需配置, 因为所有的peer都是提交节点. 在实际环境中, 一个组织内的节点需要多个, 在开发阶段, 一个组织只配置一个节点, 这个节点既是背书节点, 又是提交节点. 它可以为提交的事务提案进行背书, 可以从账本中获得信息.
</p>

<p>
另外, peer还要将事件进行广播. 只要账本新增了区块, peer节点就会广播该事件, 组织内的所有应用都可以监听到它.
</p>
</div>
</div>

<div id="outline-container-org35f6b1a" class="outline-4">
<h4 id="org35f6b1a">身份</h4>
<div class="outline-text-4" id="text-org35f6b1a">
<p>
Hyperledger Fabric网络中的每个操作都必须进行数字签名, 以便进行访问控制. 在v1.0以后, 身份基于公钥基础设施(PKI)标准. 每个orderer, peer, 用户, 交易者都必须有密钥对, 其中公钥包含在CA签名的x.509证书里. 在开发阶段, 为了简便, 我们直接使用一些工具来生成证书.
</p>

<p>
另外, 还要确定是否要在项目中加入Fabric-CA. 它是一个具有REST API的服务器, 可以支持动态身份管理, 包括注册, 登记(获取证书), 撤销和重新注册, 所以在提供用户身份时非常有用. 注意, 以这种方式配置的身份只能是 <code>MEMBER</code>, 而不是 <code>ADMIN</code>.
</p>

<p>
<code>ADMIN</code> 可以创建/更新channel, 安装/实例化chaincode, 等等.
</p>

<p>
如果不需要Fabric-CA, 也没有什么关系, 不过应用程序需要管理用户的证书.
</p>
</div>
</div>
</div>

<div id="outline-container-org002be3e" class="outline-3">
<h3 id="org002be3e">前提</h3>
<div class="outline-text-3" id="text-org002be3e">
</div>
<div id="outline-container-org7996be4" class="outline-4">
<h4 id="org7996be4">Docker</h4>
</div>

<div id="outline-container-org4c92ef0" class="outline-4">
<h4 id="org4c92ef0">Docker Compose</h4>
</div>

<div id="outline-container-org33a546d" class="outline-4">
<h4 id="org33a546d">Nodejs(v6.2.0-6.10.0)</h4>
</div>
</div>

<div id="outline-container-org750047f" class="outline-3">
<h3 id="org750047f">准备加密材料</h3>
<div class="outline-text-3" id="text-org750047f">
<p>
身份由x.509证书建立. 我们涉及到很多身份证明:
</p>
<ul class="org-ul">
<li>peer需要身份来注册背书</li>
<li>orderer需要身份来生成交易区块, 然后供给提交节点验证与加入区块链</li>
<li>应用程序需要身份来生成交易请求</li>
<li>Fabric CA需要身份, 这样它们的给证书的签名都能被验证</li>
</ul>

<p>
在开发阶段, 我们直接使用cryptogen工具来生成需要的密钥和证书.
</p>

<p>
cryptogen工具将自动为Fabric CA节点, orderer, peer生成身份, 这可以用来启动Fabric-CA服务器(如果要将Fabric CA作为项目的一部分). 另外, 它还会生成一个 <code>ADMIN</code>, 它具有特殊的操作权限. 最后, 它还生成用于提交交易的 <code>MEMBER</code>.
</p>
</div>
</div>

<div id="outline-container-orge26887d" class="outline-3">
<h3 id="orge26887d">创世区块</h3>
<div class="outline-text-3" id="text-orge26887d">
<p>
我们需要使用创世区块来启动网络. 使用configtxgen工具来生成genesis.block.
</p>
</div>
</div>

<div id="outline-container-org4488ec3" class="outline-3">
<h3 id="org4488ec3">启动网络</h3>
<div class="outline-text-3" id="text-org4488ec3">
<p>
使用docker-compose来启动网络.
</p>
</div>
</div>
</div>

<div id="outline-container-orgcbaef56" class="outline-2">
<h2 id="orgcbaef56">如何创建channel</h2>
<div class="outline-text-2" id="text-orgcbaef56">
</div>
<div id="outline-container-org9da7ea9" class="outline-3">
<h3 id="org9da7ea9">步骤</h3>
<div class="outline-text-3" id="text-org9da7ea9">
<ul class="org-ul">
<li>使用configtxgen工具, 生成genesis.block</li>
<li>使用configtxgen工具, 生成 *.tx</li>
<li>获取channel的可签名的配置文件</li>
<li>使用fabric-client SDK注册channel的可签名的配置文件</li>
<li>使用fabric-client SDK将channel可签名配置文件和签名发给orderer</li>
<li>使用fabric-client SDK将peer加入到channel</li>
</ul>
</div>
</div>

<div id="outline-container-org8f4ba90" class="outline-3">
<h3 id="org8f4ba90">使用*.tx构建可签名的channel配置</h3>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2018-04-03</span>
        <span title="last modification date" class="post-info">2018-04-11</span>
        <span title="tags" class="post-info"><a href="/tags/blockchain/">BlockChain</a></span>
        <span title="author" class="post-info">Pinvon</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2018/04/03/nodejs-fabric";
          var disqus_url = "http://pinvondev.github.io/blog/2018/04/03/nodejs-fabric";
          var disqus_shortname = 'pinvon';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
       <div id="hashover"></div>
       <script type="text/javascript" src="/hashover.php"></script>
       <noscript>You must have JavaScript enabled to use the comments.</noscript>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:pinvon &lt;at&gt; Inspiron">Pinvon</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
