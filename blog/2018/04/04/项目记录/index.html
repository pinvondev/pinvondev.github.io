<!DOCTYPE html>
<html lang="en">
<head>
  <title>项目记录 - Pinvon&#39;s Blog</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="Pinvon" />
  <meta name="description" content="&lt;TODO: insert your description here&gt;" />
  <meta name="keywords" content="BlockChain" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="https://pinvondev.github.io/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="https://pinvondev.github.io/media/css/comment.css" type="text/css"/>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://pinvondev.github.io/">Pinvon&#39;s Blog</a></h1>
    <p>所见, 所闻, 所思, 所想</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="https://pinvondev.github.io/years/">Years</a></li>
        <li><a href="https://pinvondev.github.io/authors/">Authors</a></li>
        <li><a href="https://pinvondev.github.io/tags/">Tags</a></li>
        <li><a href="https://pinvondev.github.io/about/">About</a></li>
        <li><a href="https://github.com/pinvondev">Github</a></li>
        <li><a href="https://pinvondev.github.io/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="pinvondev.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">项目记录</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga2755f8">环境搭建</a>
<ul>
<li><a href="#org37cd3b3">前提</a>
<ul>
<li><a href="#org734a057">使用脚本工具一键下载Node.js</a></li>
<li><a href="#orgc4e95c2">下载压缩包安装Node.js</a></li>
<li><a href="#org84f59a5">nvm</a></li>
</ul>
</li>
<li><a href="#orgfb3e872">下载代码</a></li>
<li><a href="#org05c37cd">启动网络</a></li>
<li><a href="#org0495783">修改配置(v1.1.0)</a>
<ul>
<li><a href="#orgc2bf04e">复制加密材料</a></li>
<li><a href="#orgfdfc92d">修改配置文件</a></li>
<li><a href="#org4eac33c">安装chaincode</a></li>
<li><a href="#org4ec4cc4">实例化chaincode</a></li>
</ul>
</li>
<li><a href="#orgab0c59b">修改配置(v1.0.0)</a>
<ul>
<li><a href="#orge12fd8f">chaincode</a></li>
</ul>
</li>
<li><a href="#org582103d">启动marbles</a></li>
</ul>
</li>
<li><a href="#orgd7cd308">项目架构</a></li>
<li><a href="#orgac7171d">网络部署</a></li>
<li><a href="#org67e0ca0">程序介绍</a></li>
<li><a href="#orgad000fe">区块链背景</a>
<ul>
<li><a href="#org303cd48">定义</a></li>
<li><a href="#org45ea603">运动能量</a>
<ul>
<li><a href="#orgf9b35ea">定义运动量化的属性</a></li>
<li><a href="#org3085570">交易信息</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf2568c9">注册</a>
<ul>
<li><a href="#org857986f">注册过程(参考fabcar例子):</a>
<ul>
<li><a href="#org78cd0b2">创建SDK实例及保存加密材料的路径</a></li>
<li><a href="#org044fc8a">创建键值存储来存储注册证书</a></li>
<li><a href="#orgea8bd6f">证书的参数设置</a></li>
<li><a href="#org7dbb52f">是否开启TLS</a></li>
<li><a href="#orge07a5b6">检查是否已登记admin</a></li>
<li><a href="#orgae6052a">注册</a></li>
<li><a href="#org2973d97">登记</a></li>
<li><a href="#org7d5c995">创建用户</a></li>
<li><a href="#orgc3b055d">设置此用户来对请求签名</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb678af1">cp</a></li>
<li><a href="#org4e74d48">utils/fc_wrangler/parts/enrollment.js</a></li>
<li><a href="#orgd3f11c4">查询chaincode</a>
<ul>
<li><a href="#orgdd1f336">调用栈</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga2755f8" class="outline-2">
<h2 id="orga2755f8">环境搭建</h2>
<div class="outline-text-2" id="text-orga2755f8">
</div>
<div id="outline-container-org37cd3b3" class="outline-3">
<h3 id="org37cd3b3">前提</h3>
<div class="outline-text-3" id="text-org37cd3b3">
<p>
安装Git, Go, Docker, Node.js.
</p>

<p>
仅介绍Node.js的安装
</p>
</div>

<div id="outline-container-org734a057" class="outline-4">
<h4 id="org734a057">使用脚本工具一键下载Node.js</h4>
<div class="outline-text-4" id="text-org734a057">
<div class="org-src-container">
<pre class="src src-Shell">cd ~
curl -sL https://deb.nodesource.com/setup_8.x -o nodesource_setup.sh
sudo bash nodesource_setup.sh
sudo apt install nodejs

# 查看node版本
node -v

# 查看npm版本
npm -v

# 为了让某些npm包能正常工作, 还要安装 build-essential
sudo apt install build-essential
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc4e95c2" class="outline-4">
<h4 id="orgc4e95c2">下载压缩包安装Node.js</h4>
<div class="outline-text-4" id="text-orgc4e95c2">
<p>
可以通过浏览器下载, 然后解压, 配置环境变量即可.
</p>

<p>
远程服务器只有终端窗口, 不能使用浏览器. 因此, 有两种方式下载:
</p>
<ol class="org-ol">
<li>使用终端上网下载</li>
<li>本地下载完成后, 再传送到远程服务器</li>
</ol>

<p>
先介绍第1种, 使用终端上网下载:
</p>
<div class="org-src-container">
<pre class="src src-Shell"># 安装w3m
sudo apt install w3m w3m-img

# 测试
w3m www.baidu.com

# 如果不能显示中文
sudo apt install zhcon
</pre>
</div>

<p>
w3m的上下左右移动, 既可以使用Vim的命令, 也可以使用Emacs的命令, 非常好用.
</p>

<p>
在需要输入文字的地方, 回车, 然后可以在终端的最下方输入文字.
</p>

<p>
U: 重新输入网址
B: 后退
T: 新开一个标签页. 标签页之间的切换, 使用"{"和"}"
C-q: 关闭当前标签页(C是Ctrl)
</p>

<p>
通过终端上网, 下载所需的压缩包. 如图所示:
<img src="https://pinvondev.github.io/assets/blog/2018/04/04/项目记录/46.png" alt="46.png" />
</p>

<p>
第2种办法是本地电脑下载压缩包, 然后使用scp来传输:
</p>
<div class="org-src-container">
<pre class="src src-Shell"># 需要使用密钥private-key, 否则需要到服务器设置使用密码登录
sudo scp -i private-key test.sh ubuntu@123.207.62.191:~/private-key

# 这样test.sh就传输到了远程服务器
</pre>
</div>

<p>
安装Node.js:
</p>
<div class="org-src-container">
<pre class="src src-Shell">xz -d node-v8.9.3-linux-x64.tar.xz 
tar -xvf node-v8.9.3-linux-x64.tar 

# 打开~/.profile文件, 添加环境变量
export NODE_HOME=~/node
export PATH=$NODE_HOME/bin:$PATH
</pre>
</div>
</div>
</div>

<div id="outline-container-org84f59a5" class="outline-4">
<h4 id="org84f59a5">nvm</h4>
<div class="outline-text-4" id="text-org84f59a5">
<p>
Node.js的安装到此就结束了. 但是IBM的Marbles使用的node版本只能是 <code>v6.2.0 - v6.11.1</code>, 而上面安装的node版本为v8.x, 因此, 还要对node的版本降级处理.
</p>

<p>
我们使用nvm来管理node的版本.
</p>

<div class="org-src-container">
<pre class="src src-Shell">sudo apt install libssl-dev
curl -sL https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh -o install_nvm.sh
bash install_nvm.sh
source ~/.profile

# 查看所有的node版本
nvm ls-remote

# 我们使用v6.10.0的版本
nvm install 6.10.0
nvm use 6.10.0

# 查看已安装的所有node
nvm ls
</pre>
</div>

<p>
由于前面安装了v8的node, 且配置了环境变量, 有时用nvm切换版本时, 会出现冲突. 解决办法:
</p>
<div class="org-src-container">
<pre class="src src-Shell">nvm deactivate
ls -la $(which npm)
rm $(which npm)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfb3e872" class="outline-3">
<h3 id="orgfb3e872">下载代码</h3>
<div class="outline-text-3" id="text-orgfb3e872">
<div class="org-src-container">
<pre class="src src-Shell">git clone https://github.com/IBM-Blockchain/marbles.git
git clone https://github.com/hyperledger/fabric-samples.git
</pre>
</div>
</div>
</div>

<div id="outline-container-org05c37cd" class="outline-3">
<h3 id="org05c37cd">启动网络</h3>
<div class="outline-text-3" id="text-org05c37cd">
<div class="org-src-container">
<pre class="src src-Shell">cd fabric-samples
curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/release-1.1/scripts/bootstrap-1.1.0-preview.sh -o setup_script.sh
sudo bash setup_script.sh

# 设置环境变量 打开 ~/.bashrc 或 ~/.profile 加入下面一句
export PATH=$PWD/bin:$PATH

# 配置好环境变量后
source ~/.bashrc
# 或者
source ~/.profile

cd fabcar
./startFabric.sh

# 安装依赖
npm install
node enrollAdmin.js

# 如果要关闭网络
cd ../bashic-network
./stop.sh
./teardown.sh
</pre>
</div>
</div>
</div>

<div id="outline-container-org0495783" class="outline-3">
<h3 id="org0495783">修改配置(v1.1.0)</h3>
<div class="outline-text-3" id="text-org0495783">
</div>
<div id="outline-container-orgc2bf04e" class="outline-4">
<h4 id="orgc2bf04e">复制加密材料</h4>
<div class="outline-text-4" id="text-orgc2bf04e">
<p>
将 <code>fabcar/hfc-key-store</code> 中的加密材料放到用户主目录下:
</p>
<div class="org-src-container">
<pre class="src src-Shell">cd fabric-samples/fabcar/hfc-key-store
rm ~/.hfc-key-store/*
cp * ~/.hfc-key-store
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfdfc92d" class="outline-4">
<h4 id="orgfdfc92d">修改配置文件</h4>
<div class="outline-text-4" id="text-orgfdfc92d">
<p>
修改 <code>marbles/config/connection_profile_local.json</code> 的 <code>client.credentialStore.path</code> 项:
</p>
<div class="org-src-container">
<pre class="src src-Shell"># 原来的路径
"path": "/$HOME/fabric-samples/fabcar/hfc-key-store"

# 改成
"path": "/$HOME/.hfc-key-store"
</pre>
</div>
</div>
</div>

<div id="outline-container-org4eac33c" class="outline-4">
<h4 id="org4eac33c">安装chaincode</h4>
<div class="outline-text-4" id="text-org4eac33c">
<div class="org-src-container">
<pre class="src src-Shell">cd marbles/scripts
node install_chaincode.js
</pre>
</div>
</div>
</div>

<div id="outline-container-org4ec4cc4" class="outline-4">
<h4 id="org4ec4cc4">实例化chaincode</h4>
<div class="outline-text-4" id="text-org4ec4cc4">
<div class="org-src-container">
<pre class="src src-Shell">cd marbles/scripts
node instantiate_chaincode.js
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgab0c59b" class="outline-3">
<h3 id="orgab0c59b">修改配置(v1.0.0)</h3>
<div class="outline-text-3" id="text-orgab0c59b">
</div>
<div id="outline-container-orge12fd8f" class="outline-4">
<h4 id="orge12fd8f">chaincode</h4>
<div class="outline-text-4" id="text-orge12fd8f">
<p>
进入marbles根目录.
</p>

<p>
修改 <code>config/connection_profile_local.json</code>:
</p>
<div class="org-src-container">
<pre class="src src-JSON">"credentialStore": {
            "path": "/home/pinvon/go/src/github.com/hyperledger/project/fabric-samples/fabcar/creds"
        }

"x-certJson": {
                "path": "/home/pinvon/go/src/github.com/hyperledger/project/fabric-samples/fabcar/creds/PeerAdmin"
            }

"registrar": [
                {
                    "enrollId": "PeerAdmin",
                    "enrollSecret": "PeerAdminpw"
                }
            ],
</pre>
</div>

<div class="org-src-container">
<pre class="src src-Shell"># 安装chaincode
cd ./scripts
node install_chaincode.js

# 实例化chaincode
node instantiate_chaincode.js
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org582103d" class="outline-3">
<h3 id="org582103d">启动marbles</h3>
<div class="outline-text-3" id="text-org582103d">
<div class="org-src-container">
<pre class="src src-Shell">cd marbles

 npm install gulp -g
#  如果失败, npm config seregistry http://registry.cnpmjs.org 再执行.

npm install

gulp marbles_local
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd7cd308" class="outline-2">
<h2 id="orgd7cd308">项目架构</h2>
<div class="outline-text-2" id="text-orgd7cd308">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">层次</th>
<th scope="col" class="org-left">描述</th>
<th scope="col" class="org-left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">应用层</td>
<td class="org-left">移动端/Web端</td>
<td class="org-left">注册 登录 计步 排行 商城 查看个人信息 邀请 发起提案 接收提案响应 发起交易 ...</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">业务层</td>
<td class="org-left">服务端</td>
<td class="org-left">用户管理 能量管理 提供RestFul接口给应用层 使用Node.js SDK与智能合约交互</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">智能合约</td>
<td class="org-left">背书 调用</td>
<td class="org-left">生成能量 提案背书 增查删改 使用gRPC与区块链交互</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">区块链</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">CA 账本</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgac7171d" class="outline-2">
<h2 id="orgac7171d">网络部署</h2>
</div>

<div id="outline-container-org67e0ca0" class="outline-2">
<h2 id="org67e0ca0">程序介绍</h2>
<div class="outline-text-2" id="text-org67e0ca0">
<p>
chaincode会创建资产, 将它存储到chaincode状态中. 资产在区块链存储(账本)中以键值对的形式创建. 账本与chaincode的交互通过对网络上的一个节点使用gRPC协议来完成. gRPC协议的细节由<a href="https://www.npmjs.com/package/fabric-client">Hyperledger Fabric Client</a> SDK处理.
</p>

<p>
项目以<a href="https://github.com/IBM-Blockchain/marbles">Marbles</a>为基础进行修改. 因此, 以Marbles程序的图片来进行介绍.
</p>


<div class="figure">
<p><img src="https://pinvondev.github.io/assets/blog/2018/04/04/项目记录/29.png" alt="29.png" />
</p>
</div>

<ol class="org-ol">
<li>admin通过浏览器与Marbles交互.</li>
<li>客户端JS代码打开一个与后端Node.js应用程序的Websocket连接. admin与该站点交互时, 客户端JS将消息发送到后端.</li>
<li>读取或写入账本称为提案. 提案由Marbles通过SDK构建, 然后发送到一个区块链节点.</li>
<li>该节点将与它的Marbles chaincode容器进行通信. chaincode将运行/模拟该交易. 如果没有 问题, 它会对该交易进行背书, 并将其发回Marbles程序.</li>
<li>Marbles通过SDK将背书后的提案发送到Orderer Service, Orderer Service将来自整个网络的许多提案打包到一个区块中, 然后, 它将新的区块广播到网络中的节点.</li>
<li>最后, 节点会验证该区块, 并将它写入自己的账本中. 该交易现已生效, 所有节点都会过来同步账本.</li>
</ol>

<p>
程序的架构主要分成3个部分:
</p>
<ol class="org-ol">
<li>chaincode: 位于 <code>/chaincode</code>.</li>
<li>客户端: 用户浏览器中所运行的JavaScript代码, 位于 <code>/public/js</code> 中.</li>
<li>服务端: 核心部分, 它充当admin与区块链之间的连接器, 位于 <code>/utils &amp; /routes</code> 中.</li>
</ol>
</div>
</div>

<div id="outline-container-orgad000fe" class="outline-2">
<h2 id="orgad000fe">区块链背景</h2>
<div class="outline-text-2" id="text-orgad000fe">
</div>
<div id="outline-container-org303cd48" class="outline-3">
<h3 id="org303cd48">定义</h3>
<div class="outline-text-3" id="text-org303cd48">
<p>
节点: 节点是区块链的成员, 运行着Hyperledger Fabric. 在marbles中, 节点归弹珠公司所有和操作.
</p>

<p>
CA: CA负责守卫我们的区块链网络. 它为客户端(如 Marbles node.js 应用程序)提供交易证书.
</p>

<p>
Orderer: 主要职责是将交易打包到区块中.
</p>

<p>
区块: 包含交易和一个验证完整性的哈希值.
</p>

<p>
交易或提案: 表示与区块链账本的交互. 对账本的读取和写入都是以交易/提案的形式发送的.
</p>

<p>
账本: 区块链在一个节点上的存储区. 它包含由交易参数和键值对组成的实际的区块数据. 由chaincode编写.
</p>

<p>
chaincode: 定义资产和所有关于资产的规则.
</p>

<p>
资产: 存在于账本中的实体. 它是一种键值对, 在Marbles中, 资产是一颗弹珠, 或弹珠所有者.
</p>

<p>
创建一颗弹珠时, 涉及的操作:
</p>
<ol class="org-ol">
<li>向网络的CA注册管理员用户. 如果成功, CA会向Marbles发送注册证书, SDK将证书存储在本地文件系统中.</li>
<li>管理员从用户界面创建一颗新弹珠时, SDK会创建一个调用事务.</li>
<li>创建弹珠的事务被构建为一个调用链代码函数 <code>init_marble()</code> 的提案.</li>
<li>Marbles通过SDK将此提案发送到一个节点进行背书.</li>
<li>节点运行 <code>init_marble()</code> 来模拟该事务, 并记录它尝试写入账本中的所有更改.</li>
<li>如果该函数成功返回, 节点会对该提案进行背书, 并将它发回Marbles. 如果失败, 错误也会发送回来, 但不会对提案进行背书.</li>
<li>Marbles通过SDK将背书后的提案发送到Orderer.</li>
<li>Orderer将组织来自整个网络的提案的序列. 它通过查找相互冲突的交易, 检查该交易序列是否有效. 任何由于冲突无法添加到区块中的交易都被标记为错误.</li>
<li>Orderer将新区块广播到网络中的节点.</li>
<li>节点收到新区块, 并通过查看各种签名和哈希值来验证它. 最后将该区块提交到节点的账本.</li>
<li>账本中会出现新的弹珠, 并很快会出现在所有节点的账本中.</li>
</ol>
</div>
</div>

<div id="outline-container-org45ea603" class="outline-3">
<h3 id="org45ea603">运动能量</h3>
<div class="outline-text-3" id="text-org45ea603">
</div>
<div id="outline-container-orgf9b35ea" class="outline-4">
<h4 id="orgf9b35ea">定义运动量化的属性</h4>
<div class="outline-text-4" id="text-orgf9b35ea">
<p>
ID(由于有资产ID, 就说明一个用户如果有多笔资产, 就有多个资产ID, 因此, 应该规定, 多少运动能量可以转化成一个资产), 量化值, 所有者, 产生时间
</p>

<p>
chaincode 中对这些资产的属性进行定义, 然后定义资产交易的规则.
</p>
</div>
</div>

<div id="outline-container-org3085570" class="outline-4">
<h4 id="org3085570">交易信息</h4>
<div class="outline-text-4" id="text-org3085570">
<p>
资产信息, 用户信息, 商家信息(或用户信息), 背书节点, 资产历史.
</p>

<p>
交易的时候, 因为有资产ID, 所以交易应该至少以一个资产为单位. 如果一个交易只涉及到 0.5 个资产, 资产ID 该如何处理? 能否分裂?
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf2568c9" class="outline-2">
<h2 id="orgf2568c9">注册</h2>
<div class="outline-text-2" id="text-orgf2568c9">
<p>
CA是最核心的组件, 主要完成对公钥的管理. 密钥有两种类型: 用于签名和用于加解密, 对应称为签名密钥对和加密密钥对. 用户基于PKI体系要申请一个证书, 一般可以由 CA 来生成证书和私钥, 也可以自己生成公钥和私钥, 然后由 CA 来对公钥进行签发.
</p>

<p>
Fabric的私钥由用户本地存储.
</p>
</div>

<div id="outline-container-org857986f" class="outline-3">
<h3 id="org857986f">注册过程(参考fabcar例子):</h3>
<div class="outline-text-3" id="text-org857986f">
</div>
<div id="outline-container-org78cd0b2" class="outline-4">
<h4 id="org78cd0b2">创建SDK实例及保存加密材料的路径</h4>
<div class="outline-text-4" id="text-org78cd0b2">
<div class="org-src-container">
<pre class="src src-JavaScript">var Fabric_Client = require('fabric-client');
var Fabric_CA_Client = require('fabric-ca-client');
var path = require('path');
var util = require('util');
var os = require('os');

var fabric_client = new Fabric_Client();
var fabric_ca_client = null;
var admin_user = null;
var member_user = null;
var store_path = path.join(__dirname, 'hfc-key-store');
</pre>
</div>
</div>
</div>

<div id="outline-container-org044fc8a" class="outline-4">
<h4 id="org044fc8a">创建键值存储来存储注册证书</h4>
<div class="outline-text-4" id="text-org044fc8a">
<div class="org-src-container">
<pre class="src src-JavaScript">Fabric_Client.newDefaultKeyValueStore({ path: store_path
}).then((state_store) =&gt; {
    // assign the store to the fabric client
    fabric_client.setStateStore(state_store);
</pre>
</div>

<p>
<code>newDefaultKeyValueStore()</code>: 将返回一个KeyValueStore类的实例. 该方法的参数, 一般只填一个路径, 该路径用于存放证书.
</p>
</div>
</div>

<div id="outline-container-orgea8bd6f" class="outline-4">
<h4 id="orgea8bd6f">证书的参数设置</h4>
<div class="outline-text-4" id="text-orgea8bd6f">
<div class="org-src-container">
<pre class="src src-JavaScript">var crypto_suite = Fabric_Client.newCryptoSuite();
var crypto_store = Fabric_Client.newCryptoKeyStore({path: store_path});
crypto_suite.setCryptoKeyStore(crypto_store);
fabric_client.setCryptoSuite(crypto_suite);
</pre>
</div>

<p>
<code>newCryptoSuite()</code>: 设置了证书中的一些内容, 如使用哪些hash算法, 使用哪些数字签名算法.
</p>

<p>
<code>newCryptoKeyStore()</code>: 设置用户的证书, 密钥等材料的存放位置.
</p>
</div>
</div>

<div id="outline-container-org7dbb52f" class="outline-4">
<h4 id="org7dbb52f">是否开启TLS</h4>
<div class="outline-text-4" id="text-org7dbb52f">
<div class="org-src-container">
<pre class="src src-JavaScript">var	tlsOptions = {
    trustedRoots: [],
    verify: false
};
fabric_ca_client = new Fabric_CA_Client('http://localhost:7054', null , '', crypto_suite);
</pre>
</div>

<p>
如果有开启TLS, 则要把 <code>http</code> 改成 <code>https</code>.
</p>
</div>
</div>

<div id="outline-container-orge07a5b6" class="outline-4">
<h4 id="orge07a5b6">检查是否已登记admin</h4>
<div class="outline-text-4" id="text-orge07a5b6">
<div class="org-src-container">
<pre class="src src-JavaScript">    return fabric_client.getUserContext('admin', true);
}).then((user_from_store) =&gt; {
    if (user_from_store &amp;&amp; user_from_store.isEnrolled()) {
        console.log('Successfully loaded admin from persistence');
        admin_user = user_from_store;
    } else {
        throw new Error('Failed to get admin.... run enrollAdmin.js');
    }
</pre>
</div>

<p>
<code>getUserContext()</code>: 根据用户名字, 返回User类. 根据第二个参数来决定是同步调用(true)还是异步调用(false), 如果是同步调用, 就会返回Promise对象的User.
</p>
</div>
</div>

<div id="outline-container-orgae6052a" class="outline-4">
<h4 id="orgae6052a">注册</h4>
<div class="outline-text-4" id="text-orgae6052a">
<div class="org-src-container">
<pre class="src src-JavaScript">return fabric_ca_client.register({enrollmentID: 'user1', affiliation: 'org1.department1',role: 'client'}, admin_user);
</pre>
</div>

<p>
<code>register()</code> 所需要的参数为: 用户名, 从属关系等, 可通过SDK查看全部参数. 该方法将会返回一个一次性密码.
</p>
</div>
</div>

<div id="outline-container-org2973d97" class="outline-4">
<h4 id="org2973d97">登记</h4>
<div class="outline-text-4" id="text-org2973d97">
<div class="org-src-container">
<pre class="src src-JavaScript">}).then((secret) =&gt; {
    console.log('Successfully registered user1 - secret:'+ secret);
    return fabric_ca_client.enroll({enrollmentID: 'user1', enrollmentSecret: secret});
</pre>
</div>

<p>
使用用户名和刚获取的一次性密码进行登记.
</p>
</div>
</div>

<div id="outline-container-org7d5c995" class="outline-4">
<h4 id="org7d5c995">创建用户</h4>
<div class="outline-text-4" id="text-org7d5c995">
<div class="org-src-container">
<pre class="src src-JavaScript">}).then((enrollment) =&gt; {
  console.log('Successfully enrolled member user "user1" ');
  return fabric_client.createUser(
     {username: 'user1',
     mspid: 'Org1MSP',
     cryptoContent: { privateKeyPEM: enrollment.key.toBytes(), signedCertPEM: enrollment.certificate }
     });
</pre>
</div>

<p>
<code>createUser()</code>: 基于私钥和签名证书, 返回一个User对象. 也可以使用已经存在的私钥和证书来创建User对象.
</p>
</div>
</div>

<div id="outline-container-orgc3b055d" class="outline-4">
<h4 id="orgc3b055d">设置此用户来对请求签名</h4>
<div class="outline-text-4" id="text-orgc3b055d">
<div class="org-src-container">
<pre class="src src-JavaScript">}).then((user) =&gt; {
     member_user = user;
     return fabric_client.setUserContext(member_user);
}).then(()=&gt;{
     console.log('User1 was successfully registered and enrolled and is ready to intreact with the fabric network');
}).catch((err) =&gt; {
    console.error('Failed to register: ' + err);
    if(err.toString().indexOf('Authorization') &gt; -1) {
        console.error('Authorization failures may be caused by having admin credentials from a previous CA instance.\n' +
        'Try again after deleting the contents of the store directory '+store_path);
    }
});
</pre>
</div>

<p>
在此以后, 与Fabric的交互, 都会使用该用户的私钥和证书来进行签名.
</p>

<p>
注册时, 服务器向ECA(enroll ca)发出注册请求. <code>register()</code> 需要两个参数, 第1个参数是json格式的, 内容有登记ID, 属于哪个org等, 第2个参数是执行注册的用户, 一般是admin. 
</p>

<p>
如果传入的登记ID尚未注册, 则ECA返回一个一次性密码.
</p>

<p>
服务器向ECA发出登记请求. <code>enroll()</code> 包含1个参数, 参数内容为JSON格式, 主要有登记ID, 一次性密码等.
</p>

<p>
ECA验证后, 返回一个登记证书对. 这个证书对包含两个证书, 一个用于签名, 一个用于加密.
</p>

<p>
fabric_client.createUser(). 参数包括登记ID, 组织ID, 私钥PEM文件, 签名PEM文件. 返回User对象.
</p>

<p>
fabric_client.setUserContext(). 参数为User对象. 以后这个用户的私钥和证书会在Fabric后端中为该用户的请求进行签名.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb678af1" class="outline-2">
<h2 id="orgb678af1">cp</h2>
<div class="outline-text-2" id="text-orgb678af1">
<p>
用于获取配置信息. 先解析 <code>config/marbles_local.json</code> 文件, 获取连接的配置文件, 心跳间隔, 客户端连接端口等信息.
</p>

<p>
然后解析获取的连接配置文件 <code>config/connection_profile_local.json</code>. 这里包含有许多重要信息.
</p>

<ol class="org-ol">
<li>客户端属于哪个组织, 证书存放位置</li>
<li>channel信息: 包含哪些orderer, peer, chaincode, x-blockDelay</li>
<li>org信息: id, 包含的peer的信息, CA信息, PeerAdmin的证书信息</li>
<li>orderer信息: 地址信息</li>
<li>peer信息: 地址信息</li>
<li>CA信息: 地址信息, 注册员信息</li>
</ol>
</div>
</div>

<div id="outline-container-org4e74d48" class="outline-2">
<h2 id="org4e74d48">utils/fc_wrangler/parts/enrollment.js</h2>
<div class="outline-text-2" id="text-org4e74d48">
<p>
此文件用于注册用户.
</p>

<p>
注册管理员:
</p>

<ol class="org-ol">
<li>创建SDK实例.</li>
<li>我们使用 <code>newDefaultKeyValueStore</code> 创建一个键值存储来存储我们的注册证书.</li>
<li>注册管理员. 在执行这一步时使用了enrollID和注册密钥向CA执行身份验证. CA将颁发注册证书, SDK将该证书存储在键值存储中. 因为我们使用的是默认的键值存储, 所以它会存储在本地文件系统中.</li>
<li>成功注册后, 设置orderer URL. 暂时不需要订购者, 但在我们尝试调用链代码时需要它. 仅在拥有自签名证书时, 才需要包含 ssl-target-name-override 的业务. 将此字段与您创建 PEM 文件时使用的常用名设置为相同.</li>
<li>接下来设置节点 URL. 这些 URL 也是暂时不需要的, 但我们将会完整设置我们的 SDK 链对象.</li>
<li>此刻, 已对 SDK 进行全面配置并准备好与区块链进行交互.</li>
</ol>

<p>
注册普通用户:
参考fabcar/registerUser.js
</p>
</div>
</div>
<div id="outline-container-orgd3f11c4" class="outline-2">
<h2 id="orgd3f11c4">查询chaincode</h2>
<div class="outline-text-2" id="text-orgd3f11c4">
</div>
<div id="outline-container-orgdd1f336" class="outline-3">
<h3 id="orgdd1f336">调用栈</h3>
<div class="outline-text-3" id="text-orgdd1f336">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">query_cc.js</th>
<th scope="col" class="org-left">query_cc.query_chaincode(obj, options, cb)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">index.js</td>
<td class="org-left">fcw.query_chaincode(obj, options, cb_done)</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">marbles_cc_lib.js</td>
<td class="org-left">fcw.query_chaincode(enrollobj, options, cb)</td>
</tr>
</tbody>
</table>


<p>
在 <code>marbles_cc_lib.js</code> 的 <code>fcw.query_chaincode(enrollobj, options, cb)</code> 中, 可以查到 <code>options</code> 的内容. 如下:
</p>
<div class="org-src-container">
<pre class="src src-JavaScript">var opts = {
    peer_urls: g_options.peer_urls,
    peer_tls_opts: g_options.peer_tls_opts,
    channel_id: g_options.channel_id,
    chaincode_id: g_options.chaincode_id,
    chaincode_version: g_options.chaincode_version,
    cc_function: 'read',
    cc_args: ['selftest']
};
</pre>
</div>
</div>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2018-04-04</span>
            <span title="last modification date" class="post-info">2018-05-13</span>
            <span title="tags" class="post-info">:<a href="https://pinvondev.github.io/tags/blockchain">BlockChain</a>:</span>
            <span title="author" class="post-info"><a href="mailto:pinvon@Inspiron">Pinvon</a></span>
        </div>
    <script src="https://pinvondev.github.io/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2018/04/04/项目记录";
         var disqus_url = "https://pinvondev.github.io/blog/2018/04/04/项目记录";
         var disqus_shortname = 'pinvon';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="https://pinvondev.github.io/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:pinvon@Inspiron">Pinvon</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
            <script type="text/javascript" src="/media/js/love.js"></script>
</div>

  </div></body>
</html>
