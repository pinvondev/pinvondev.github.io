<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>项目记录 - Pinvon&#39;s Blog</title>
    <meta charset="utf-8" />
    <meta name="author" content="Pinvon" />
    <meta name="description" content="&lt;TODO: insert your description here&gt;" />
    <meta name="keywords" content="&lt;TODO: insert your keywords here&gt;" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">Pinvon&#39;s Blog</a></h1>
        <p>所见，所闻，所思，所想</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/pinvondev">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="pinvondev.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>项目记录</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb88853f">环境搭建</a>
<ul>
<li><a href="#org0e8e2b2">前提</a></li>
<li><a href="#org4c1798b">下载代码</a></li>
<li><a href="#orge9f2e39">启动网络</a></li>
<li><a href="#org8298183">启动marbles</a>
<ul>
<li><a href="#orga09fd9a">chaincode</a></li>
<li><a href="#orgcf755c6">启动marbles</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org00c317c">程序介绍</a></li>
<li><a href="#org02b4129">区块链背景</a>
<ul>
<li><a href="#org6b39aaa">定义</a></li>
</ul>
</li>
<li><a href="#org70fdcc2">注册</a>
<ul>
<li><a href="#org2685201">注册过程(参考fabcar例子):</a>
<ul>
<li><a href="#org01e0b2a">创建SDK实例及保存加密材料的路径</a></li>
<li><a href="#org7ab6d03">创建键值存储来存储注册证书</a></li>
<li><a href="#orgde15625">证书的参数设置</a></li>
<li><a href="#org949f9d7">是否开启TLS</a></li>
<li><a href="#org906f061">检查是否已登记admin</a></li>
<li><a href="#orgbd76177">注册</a></li>
<li><a href="#orgbebf60b">登记</a></li>
<li><a href="#org39b7dbb">创建用户</a></li>
<li><a href="#org43dcee4">设置此用户来对请求签名</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9edbdc4">cp</a></li>
<li><a href="#orgf2f2c6b">utils/fc_wrangler/parts/enrollment.js</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb88853f" class="outline-2">
<h2 id="orgb88853f">环境搭建</h2>
<div class="outline-text-2" id="text-orgb88853f">
</div>
<div id="outline-container-org0e8e2b2" class="outline-3">
<h3 id="org0e8e2b2">前提</h3>
<div class="outline-text-3" id="text-org0e8e2b2">
<p>
安装git, go, docker, node.js
</p>
</div>
</div>

<div id="outline-container-org4c1798b" class="outline-3">
<h3 id="org4c1798b">下载代码</h3>
<div class="outline-text-3" id="text-org4c1798b">
<div class="org-src-container">
<pre class="src src-Shell">git clone https://github.com/IBM-Blockchain/marbles.git
cd marble
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9f2e39" class="outline-3">
<h3 id="orge9f2e39">启动网络</h3>
<div class="outline-text-3" id="text-orge9f2e39">
<div class="org-src-container">
<pre class="src src-Shell">git clone https://github.com/hyperledger/fabric-samples
cd fabric-samples
git checkout v1.0.1

curl -sSL https://goo.gl/6wtTN5 | bash -s 1.0.0
# 或者
curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/master/scripts/bootstrap.sh | bash -s 1.0.0

# 设置环境变量
export PATH=$PWD/bin:$PATH

cd fabcar
./startFabric.sh

# 安装依赖
sudo npm install

# 如果要关闭网络
cd ../bashic-network
./stop.sh
./teardown.sh
</pre>
</div>
</div>
</div>

<div id="outline-container-org8298183" class="outline-3">
<h3 id="org8298183">启动marbles</h3>
<div class="outline-text-3" id="text-org8298183">
</div>
<div id="outline-container-orga09fd9a" class="outline-4">
<h4 id="orga09fd9a">chaincode</h4>
<div class="outline-text-4" id="text-orga09fd9a">
<p>
进入marbles根目录.
</p>

<p>
修改 <code>config/connection_profile_local.json</code>:
</p>
<div class="org-src-container">
<pre class="src src-JSON">"credentialStore": {
            "path": "/home/pinvon/go/src/github.com/hyperledger/project/fabric-samples/fabcar/creds"
        }

"x-certJson": {
                "path": "/home/pinvon/go/src/github.com/hyperledger/project/fabric-samples/fabcar/creds/PeerAdmin"
            }

"registrar": [
                {
                    "enrollId": "PeerAdmin",
                    "enrollSecret": "PeerAdminpw"
                }
            ],
</pre>
</div>

<div class="org-src-container">
<pre class="src src-Shell"># 安装chaincode
cd ./scripts
node install_chaincode.js

# 实例化chaincode
node instantiate_chaincode.js
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf755c6" class="outline-4">
<h4 id="orgcf755c6">启动marbles</h4>
<div class="outline-text-4" id="text-orgcf755c6">
<div class="org-src-container">
<pre class="src src-Shell"> npm install gulp -g
#  如果失败, npm config seregistry http://registry.cnpmjs.org 再执行.
npm install
gulp marbles_local
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org00c317c" class="outline-2">
<h2 id="org00c317c">程序介绍</h2>
<div class="outline-text-2" id="text-org00c317c">
<p>
chaincode会创建资产, 将它存储到chaincode状态中. 资产在区块链存储(账本)中以键值对的形式创建. 账本与chaincode的交互通过对网络上的一个节点使用gRPC协议来完成. gRPC协议的细节由<a href="https://www.npmjs.com/package/fabric-client">Hyperledger Fabric Client</a> SDK处理.
</p>

<p>
项目以<a href="https://github.com/IBM-Blockchain/marbles">Marbles</a>为基础进行修改. 因此, 以Marbles程序的图片来进行介绍.
</p>


<div class="figure">
<p><img src="/assets/blog/2018/04/04/项目记录/29.png" alt="29.png" />
</p>
</div>

<ol class="org-ol">
<li>admin通过浏览器与Marbles交互.</li>
<li>客户端JS代码打开一个与后端Node.js应用程序的Websocket连接. admin与该站点交互时, 客户端JS将消息发送到后端.</li>
<li>读取或写入账本称为提案. 提案由Marbles通过SDK构建, 然后发送到一个区块链节点.</li>
<li>该节点将与它的Marbles chaincode容器进行通信. chaincode将运行/模拟该交易. 如果没有 问题, 它会对该交易进行背书, 并将其发回Marbles程序.</li>
<li>Marbles通过SDK将背书后的提案发送到Orderer Service, Orderer Service将来自整个网络的许多提案打包到一个区块中, 然后, 它将新的区块广播到网络中的节点.</li>
<li>最后, 节点会验证该区块, 并将它写入自己的账本中. 该交易现已生效, 所有节点都会过来同步账本.</li>
</ol>

<p>
程序的架构主要分成3个部分:
</p>
<ol class="org-ol">
<li>chaincode: 位于 <code>/chaincode</code>.</li>
<li>客户端: 用户浏览器中所运行的JavaScript代码, 位于 <code>/public/js</code> 中.</li>
<li>服务端: 核心部分, 它充当admin与区块链之间的连接器, 位于 <code>/utils &amp; /routes</code> 中.</li>
</ol>
</div>
</div>

<div id="outline-container-org02b4129" class="outline-2">
<h2 id="org02b4129">区块链背景</h2>
<div class="outline-text-2" id="text-org02b4129">
</div>
<div id="outline-container-org6b39aaa" class="outline-3">
<h3 id="org6b39aaa">定义</h3>
<div class="outline-text-3" id="text-org6b39aaa">
<p>
节点: 节点是区块链的成员, 运行着Hyperledger Fabric. 在marbles中, 节点归弹珠公司所有和操作.
</p>

<p>
CA: CA负责守卫我们的区块链网络. 它为客户端(如 Marbles node.js 应用程序)提供交易证书.
</p>

<p>
Orderer: 主要职责是将交易打包到区块中.
</p>

<p>
区块: 包含交易和一个验证完整性的哈希值.
</p>

<p>
交易或提案: 表示与区块链账本的交互. 对账本的读取和写入都是以交易/提案的形式发送的.
</p>

<p>
账本: 区块链在一个节点上的存储区. 它包含由交易参数和键值对组成的实际的区块数据. 由chaincode编写.
</p>

<p>
chaincode: 定义资产和所有关于资产的规则.
</p>

<p>
资产: 存在于账本中的实体. 它是一种键值对, 在Marbles中, 资产是一颗弹珠, 或弹珠所有者.
</p>

<p>
创建一颗弹珠时, 涉及的操作:
</p>
<ol class="org-ol">
<li>向网络的CA注册管理员用户. 如果成功, CA会向Marbles发送注册证书, SDK将证书存储在本地文件系统中.</li>
<li>管理员从用户界面创建一颗新弹珠时, SDK会创建一个调用事务.</li>
<li>创建弹珠的事务被构建为一个调用链代码函数 <code>init_marble()</code> 的提案.</li>
<li>Marbles通过SDK将此提案发送到一个节点进行背书.</li>
<li>节点运行 <code>init_marble()</code> 来模拟该事务, 并记录它尝试写入账本中的所有更改.</li>
<li>如果该函数成功返回, 节点会对该提案进行背书, 并将它发回Marbles. 如果失败, 错误也会发送回来, 但不会对提案进行背书.</li>
<li>Marbles通过SDK将背书后的提案发送到Orderer.</li>
<li>Orderer将组织来自整个网络的提案的序列. 它通过查找相互冲突的交易, 检查该交易序列是否有效. 任何由于冲突无法添加到区块中的交易都被标记为错误.</li>
<li>Orderer将新区块广播到网络中的节点.</li>
<li>节点收到新区块, 并通过查看各种签名和哈希值来验证它. 最后将该区块提交到节点的账本.</li>
<li>账本中会出现新的弹珠, 并很快会出现在所有节点的账本中.</li>
</ol>
</div>
</div>
</div>




<div id="outline-container-org70fdcc2" class="outline-2">
<h2 id="org70fdcc2">注册</h2>
<div class="outline-text-2" id="text-org70fdcc2">
<p>
CA是最核心的组件, 主要完成对公钥的管理. 密钥有两种类型: 用于签名和用于加解密, 对应称为签名密钥对和加密密钥对. 用户基于PKI体系要申请一个证书, 一般可以由 CA 来生成证书和私钥, 也可以自己生成公钥和私钥, 然后由 CA 来对公钥进行签发.
</p>

<p>
Fabric的私钥由用户本地存储.
</p>
</div>

<div id="outline-container-org2685201" class="outline-3">
<h3 id="org2685201">注册过程(参考fabcar例子):</h3>
<div class="outline-text-3" id="text-org2685201">
</div>
<div id="outline-container-org01e0b2a" class="outline-4">
<h4 id="org01e0b2a">创建SDK实例及保存加密材料的路径</h4>
<div class="outline-text-4" id="text-org01e0b2a">
<div class="org-src-container">
<pre class="src src-JavaScript">var Fabric_Client = require('fabric-client');
var Fabric_CA_Client = require('fabric-ca-client');
var path = require('path');
var util = require('util');
var os = require('os');

var fabric_client = new Fabric_Client();
var fabric_ca_client = null;
var admin_user = null;
var member_user = null;
var store_path = path.join(__dirname, 'hfc-key-store');
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ab6d03" class="outline-4">
<h4 id="org7ab6d03">创建键值存储来存储注册证书</h4>
<div class="outline-text-4" id="text-org7ab6d03">
<div class="org-src-container">
<pre class="src src-JavaScript">Fabric_Client.newDefaultKeyValueStore({ path: store_path
}).then((state_store) =&gt; {
    // assign the store to the fabric client
    fabric_client.setStateStore(state_store);
</pre>
</div>

<p>
<code>newDefaultKeyValueStore()</code>: 将返回一个KeyValueStore类的实例. 该方法的参数, 一般只填一个路径, 该路径用于存放证书.
</p>
</div>
</div>

<div id="outline-container-orgde15625" class="outline-4">
<h4 id="orgde15625">证书的参数设置</h4>
<div class="outline-text-4" id="text-orgde15625">
<div class="org-src-container">
<pre class="src src-JavaScript">var crypto_suite = Fabric_Client.newCryptoSuite();
var crypto_store = Fabric_Client.newCryptoKeyStore({path: store_path});
crypto_suite.setCryptoKeyStore(crypto_store);
fabric_client.setCryptoSuite(crypto_suite);
</pre>
</div>

<p>
<code>newCryptoSuite()</code>: 设置了证书中的一些内容, 如使用哪些hash算法, 使用哪些数字签名算法.
</p>

<p>
<code>newCryptoKeyStore()</code>: 设置用户的证书, 密钥等材料的存放位置.
</p>
</div>
</div>

<div id="outline-container-org949f9d7" class="outline-4">
<h4 id="org949f9d7">是否开启TLS</h4>
<div class="outline-text-4" id="text-org949f9d7">
<div class="org-src-container">
<pre class="src src-JavaScript">var	tlsOptions = {
    trustedRoots: [],
    verify: false
};
fabric_ca_client = new Fabric_CA_Client('http://localhost:7054', null , '', crypto_suite);
</pre>
</div>

<p>
如果有开启TLS, 则要把 <code>http</code> 改成 <code>https</code>.
</p>
</div>
</div>

<div id="outline-container-org906f061" class="outline-4">
<h4 id="org906f061">检查是否已登记admin</h4>
<div class="outline-text-4" id="text-org906f061">
<div class="org-src-container">
<pre class="src src-JavaScript">    return fabric_client.getUserContext('admin', true);
}).then((user_from_store) =&gt; {
    if (user_from_store &amp;&amp; user_from_store.isEnrolled()) {
        console.log('Successfully loaded admin from persistence');
        admin_user = user_from_store;
    } else {
        throw new Error('Failed to get admin.... run enrollAdmin.js');
    }
</pre>
</div>

<p>
<code>getUserContext()</code>: 根据用户名字, 返回User类. 根据第二个参数来决定是同步调用(true)还是异步调用(false), 如果是同步调用, 就会返回Promise对象的User.
</p>
</div>
</div>

<div id="outline-container-orgbd76177" class="outline-4">
<h4 id="orgbd76177">注册</h4>
<div class="outline-text-4" id="text-orgbd76177">
<div class="org-src-container">
<pre class="src src-JavaScript">return fabric_ca_client.register({enrollmentID: 'user1', affiliation: 'org1.department1',role: 'client'}, admin_user);
</pre>
</div>

<p>
<code>register()</code> 所需要的参数为: 用户名, 从属关系等, 可通过SDK查看全部参数. 该方法将会返回一个一次性密码.
</p>
</div>
</div>

<div id="outline-container-orgbebf60b" class="outline-4">
<h4 id="orgbebf60b">登记</h4>
<div class="outline-text-4" id="text-orgbebf60b">
<div class="org-src-container">
<pre class="src src-JavaScript">}).then((secret) =&gt; {
    console.log('Successfully registered user1 - secret:'+ secret);
    return fabric_ca_client.enroll({enrollmentID: 'user1', enrollmentSecret: secret});
</pre>
</div>

<p>
使用用户名和刚获取的一次性密码进行登记.
</p>
</div>
</div>

<div id="outline-container-org39b7dbb" class="outline-4">
<h4 id="org39b7dbb">创建用户</h4>
<div class="outline-text-4" id="text-org39b7dbb">
<div class="org-src-container">
<pre class="src src-JavaScript">}).then((enrollment) =&gt; {
  console.log('Successfully enrolled member user "user1" ');
  return fabric_client.createUser(
     {username: 'user1',
     mspid: 'Org1MSP',
     cryptoContent: { privateKeyPEM: enrollment.key.toBytes(), signedCertPEM: enrollment.certificate }
     });
</pre>
</div>

<p>
<code>createUser()</code>: 基于私钥和签名证书, 返回一个User对象. 也可以使用已经存在的私钥和证书来创建User对象.
</p>
</div>
</div>

<div id="outline-container-org43dcee4" class="outline-4">
<h4 id="org43dcee4">设置此用户来对请求签名</h4>
<div class="outline-text-4" id="text-org43dcee4">
<div class="org-src-container">
<pre class="src src-JavaScript">}).then((user) =&gt; {
     member_user = user;
     return fabric_client.setUserContext(member_user);
}).then(()=&gt;{
     console.log('User1 was successfully registered and enrolled and is ready to intreact with the fabric network');
}).catch((err) =&gt; {
    console.error('Failed to register: ' + err);
    if(err.toString().indexOf('Authorization') &gt; -1) {
        console.error('Authorization failures may be caused by having admin credentials from a previous CA instance.\n' +
        'Try again after deleting the contents of the store directory '+store_path);
    }
});
</pre>
</div>

<p>
在此以后, 与Fabric的交互, 都会使用该用户的私钥和证书来进行签名.
</p>

<p>
注册时, 服务器向ECA(enroll ca)发出注册请求. <code>register()</code> 需要两个参数, 第1个参数是json格式的, 内容有登记ID, 属于哪个org等, 第2个参数是执行注册的用户, 一般是admin. 
</p>

<p>
如果传入的登记ID尚未注册, 则ECA返回一个一次性密码.
</p>

<p>
服务器向ECA发出登记请求. <code>enroll()</code> 包含1个参数, 参数内容为JSON格式, 主要有登记ID, 一次性密码等.
</p>

<p>
ECA验证后, 返回一个登记证书对. 这个证书对包含两个证书, 一个用于签名, 一个用于加密.
</p>

<p>
fabric_client.createUser(). 参数包括登记ID, 组织ID, 私钥PEM文件, 签名PEM文件. 返回User对象.
</p>

<p>
fabric_client.setUserContext(). 参数为User对象. 以后这个用户的私钥和证书会在Fabric后端中为该用户的请求进行签名.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org9edbdc4" class="outline-2">
<h2 id="org9edbdc4">cp</h2>
<div class="outline-text-2" id="text-org9edbdc4">
<p>
用于获取配置信息. 先解析 <code>config/marbles_local.json</code> 文件, 获取连接的配置文件, 心跳间隔, 客户端连接端口等信息.
</p>

<p>
然后解析获取的连接配置文件 <code>config/connection_profile_local.json</code>. 这里包含有许多重要信息.
</p>

<ol class="org-ol">
<li>客户端属于哪个组织, 证书存放位置</li>
<li>channel信息: 包含哪些orderer, peer, chaincode, x-blockDelay</li>
<li>org信息: id, 包含的peer的信息, CA信息, PeerAdmin的证书信息</li>
<li>orderer信息: 地址信息</li>
<li>peer信息: 地址信息</li>
<li>CA信息: 地址信息, 注册员信息</li>
</ol>
</div>
</div>

<div id="outline-container-orgf2f2c6b" class="outline-2">
<h2 id="orgf2f2c6b">utils/fc_wrangler/parts/enrollment.js</h2>
<div class="outline-text-2" id="text-orgf2f2c6b">
<p>
此文件用于注册用户.
</p>

<p>
注册管理员:
</p>

<ol class="org-ol">
<li>创建SDK实例.</li>
<li>我们使用 <code>newDefaultKeyValueStore</code> 创建一个键值存储来存储我们的注册证书.</li>
<li>注册管理员. 在执行这一步时使用了enrollID和注册密钥向CA执行身份验证. CA将颁发注册证书, SDK将该证书存储在键值存储中. 因为我们使用的是默认的键值存储, 所以它会存储在本地文件系统中.</li>
<li>成功注册后, 设置orderer URL. 暂时不需要订购者, 但在我们尝试调用链代码时需要它. 仅在拥有自签名证书时, 才需要包含 ssl-target-name-override 的业务. 将此字段与您创建 PEM 文件时使用的常用名设置为相同.</li>
<li>接下来设置节点 URL. 这些 URL 也是暂时不需要的, 但我们将会完整设置我们的 SDK 链对象.</li>
<li>此刻, 已对 SDK 进行全面配置并准备好与区块链进行交互.</li>
</ol>

<p>
注册普通用户:
参考fabcar/registerUser.js
</p>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2018-04-04</span>
        <span title="last modification date" class="post-info">2018-04-11</span>
        <span title="tags" class="post-info"><a href="/tags/blockchain/">BlockChain</a></span>
        <span title="author" class="post-info">Pinvon</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2018/04/04/项目记录";
          var disqus_url = "http://pinvondev.github.io/blog/2018/04/04/项目记录";
          var disqus_shortname = 'pinvon';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
       <div id="hashover"></div>
       <script type="text/javascript" src="/hashover.php"></script>
       <noscript>You must have JavaScript enabled to use the comments.</noscript>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:pinvon &lt;at&gt; Inspiron">Pinvon</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
